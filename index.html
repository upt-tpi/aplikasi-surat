<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Manajemen Surat</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; }
        .header-content { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
        .header h1 { font-size: 2rem; margin-bottom: 10px; }
        .config-section { background: #f8f9fa; border-bottom: 2px solid #e0e0e0; }
        .config-header { padding: 15px 30px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; user-select: none; }
        .config-header:hover { background: #e9ecef; }
        .config-header h3 { font-size: 1rem; color: #333; display: flex; align-items: center; gap: 10px; }
        .config-toggle { font-size: 1.2rem; transition: transform 0.3s; }
        .config-toggle.open { transform: rotate(180deg); }
        .config-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
        .config-content.open { max-height: 500px; padding: 20px 30px; }
        .config-row { display: flex; gap: 15px; align-items: flex-end; flex-wrap: wrap; }
        .config-group { flex: 1; min-width: 250px; }
        .config-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; font-size: 0.9rem; }
        .config-group input { width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 0.9rem; }
        .sync-status { display: flex; align-items: center; gap: 8px; padding: 8px 16px; border-radius: 8px; font-size: 0.85rem; font-weight: 600; }
        .sync-status.connected { background: #d4edda; color: #155724; }
        .sync-status.disconnected { background: #f8d7da; color: #721c24; }
        .tabs { display: flex; background: #f8f9fa; border-bottom: 2px solid #e0e0e0; }
        .tab { flex: 1; padding: 20px; text-align: center; cursor: pointer; background: #f8f9fa; border: none; font-size: 1rem; font-weight: 600; color: #666; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .tab:hover { background: #e9ecef; }
        .tab.active { background: white; color: #667eea; border-bottom: 3px solid #667eea; }
        .content { padding: 30px; }
        .toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; gap: 15px; flex-wrap: wrap; }
        .search-box { display: flex; align-items: center; background: #f8f9fa; padding: 10px 15px; border-radius: 8px; flex: 1; min-width: 250px; }
        .search-box input { border: none; background: none; outline: none; width: 100%; margin-left: 10px; font-size: 0.95rem; }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-size: 0.95rem; font-weight: 600; transition: all 0.3s; display: flex; align-items: center; gap: 8px; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4); }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-warning { background: #ffc107; color: #333; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-info { background: #17a2b8; color: white; }
        .btn-sm { padding: 6px 12px; font-size: 0.85rem; }
        .table-container { width: 100%; overflow-x: auto; margin-top: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        table { width: 100%; border-collapse: collapse; background: white; min-width: 800px; }
        thead { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; position: sticky; top: 0; z-index: 5; }
        th { padding: 15px 10px; text-align: left; font-weight: 600; font-size: 0.85rem; white-space: nowrap; }
        td { padding: 12px 10px; border-bottom: 1px solid #e0e0e0; font-size: 0.85rem; vertical-align: top; }
        tbody tr { transition: all 0.2s; }
        tbody tr:hover { background: #f8f9fa; }
        .actions { display: flex; gap: 8px; flex-wrap: wrap; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 15px; width: 90%; max-width: 700px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .modal-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h2 { font-size: 1.5rem; }
        .close-btn { background: rgba(255,255,255,0.2); border: none; color: white; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s; font-size: 1.5rem; }
        .close-btn:hover { background: rgba(255,255,255,0.3); }
        .modal-body { padding: 30px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; font-size: 0.9rem; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 0.95rem; transition: all 0.3s; }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
        .form-group textarea { resize: vertical; min-height: 100px; }
        .modal-footer { padding: 20px 30px; background: #f8f9fa; display: flex; justify-content: flex-end; gap: 10px; }
        .empty-state { text-align: center; padding: 60px 20px; color: #999; }
        .empty-state svg { width: 80px; height: 80px; margin-bottom: 20px; opacity: 0.5; }
        .badge { display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 0.8rem; font-weight: 600; }
        .badge-success { background: #d4edda; color: #155724; }
        .badge-warning { background: #fff3cd; color: #856404; }
        .badge-danger { background: #f8d7da; color: #721c24; }
        .badge-secondary { background: #e2e3e5; color: #383d41; }
        .alert { padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 0.9rem; }
        .alert-info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-danger { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .alert-warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .loading { display: inline-block; width: 16px; height: 16px; border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: white; animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .pagination { display: flex; justify-content: center; align-items: center; margin-top: 20px; gap: 5px; }
        .pagination button { padding: 8px 12px; border: 1px solid #e0e0e0; background: white; border-radius: 5px; cursor: pointer; font-size: 0.9rem; }
        .pagination button:hover:not(:disabled) { background: #f3f4f6; }
        .pagination button.active { background: #667eea; color: white; border-color: #667eea; }
        .pagination button:disabled { opacity: 0.5; cursor: not-allowed; }
        .pagination-info { margin: 0 15px; font-size: 0.9rem; color: #6b7280; }
        .file-link { color: #667eea; text-decoration: none; font-weight: 500; }
        .file-link:hover { text-decoration: underline; }
        @media (max-width: 768px) {
            .header h1 { font-size: 1.5rem; }
            .toolbar { flex-direction: column; }
            .search-box { width: 100%; }
            .pagination { flex-wrap: wrap; }
            td, th { white-space: normal; word-wrap: break-word; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <div>
                    <h1>üìß Aplikasi Manajemen Surat</h1>
                    <p>Kelola Surat Masuk dan Surat Keluar dengan Integrasi Google Sheets</p>
                </div>
                <button class="btn btn-danger" onclick="logout()"><span>üö™</span> Logout</button>
            </div>
        </div>

        <div class="config-section">
            <div class="config-header" onclick="toggleConfig()">
                <h3>‚öôÔ∏è Konfigurasi API & Sinkronisasi</h3>
                <span class="config-toggle" id="configToggle">‚ñº</span>
            </div>
            <div class="config-content" id="configContent">
                <div class="alert alert-warning">‚ö†Ô∏è <strong>Penting:</strong> Deploy Google Apps Script dengan akses <strong>"Anyone"</strong></div>
                <div class="config-row">
                    <div class="config-group">
                        <label>üîó Google Apps Script Web App URL</label>
                        <input type="url" id="apiUrl" value="https://script.google.com/macros/s/AKfycbx4XftW56EsHKxvmOS2gi7To5SNZpAM4Pwqx37IpubebFcfwDp-3wJbLMZLbzszWNs9/exec" readonly>
                    </div>
                    <button class="btn btn-info" onclick="testConnection()"><span id="testBtnText">üîå Test Koneksi</span></button>
                    <button class="btn btn-success" onclick="syncFromSheet()"><span id="syncBtnText">üîÑ Sync Data</span></button>
                </div>
                <div style="margin-top: 15px;">
                    <div id="connectionStatus" class="sync-status disconnected"><span>‚óè</span> Belum Terhubung</div>
                </div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('masuk')"><span>üì•</span> Surat Masuk</button>
            <button class="tab" onclick="switchTab('keluar')"><span>üì§</span> Surat Keluar</button>
        </div>

        <div class="content">
            <div id="alertContainer"></div>
            <div class="toolbar">
                <div class="search-box">
                    <span>üîç</span>
                    <input type="text" id="searchInput" placeholder="Cari surat..." onkeyup="filterTable()">
                </div>
                <button class="btn btn-secondary btn-sm" onclick="showDebugInfo()">üêõ Debug</button>
                <button class="btn btn-primary" onclick="openModal('add')"><span>‚ûï</span> Tambah Surat</button>
            </div>
            <div id="tableContainer"></div>
        </div>
    </div>

    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Tambah Surat</h2>
                <button class="close-btn" onclick="closeModal()">‚úï</button>
            </div>
            <div class="modal-body">
                <form id="suratForm"><div id="formFields"></div></form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">Batal</button>
                <button class="btn btn-success" onclick="saveSurat()"><span id="saveBtnText">üíæ Simpan</span></button>
            </div>
        </div>
    </div>

    <script>
        let activeTab='masuk',suratMasuk=[],suratKeluar=[],editingId=null,currentPage=1;
        const itemsPerPage=10,apiUrl='https://script.google.com/macros/s/AKfycbx4XftW56EsHKxvmOS2gi7To5SNZpAM4Pwqx37IpubebFcfwDp-3wJbLMZLbzszWNs9/exec';
        let filteredData=[];

        window.addEventListener('load',()=>{
            if(localStorage.getItem('isLoggedIn')!=='true'){
                window.location.href='https://upt-tpi.github.io/aplikasi-surat/login.html';
                return;
            }
            document.getElementById('apiUrl').value=apiUrl;
            loadLocalData();
            renderTable();
            setTimeout(()=>testConnection(),1000);
        });

        function toggleConfig(){
            const c=document.getElementById('configContent'),t=document.getElementById('configToggle');
            if(c.classList.contains('open')){c.classList.remove('open');t.classList.remove('open');}
            else{c.classList.add('open');t.classList.add('open');}
        }

        function loadLocalData(){
            try{
                const m=localStorage.getItem('surat-masuk'),k=localStorage.getItem('surat-keluar');
                if(m)suratMasuk=JSON.parse(m);
                if(k)suratKeluar=JSON.parse(k);
                filteredData=activeTab==='masuk'?[...suratMasuk]:[...suratKeluar];
            }catch(e){console.log('Data lokal belum ada:',e);}
        }

        function saveLocalData(){
            try{
                localStorage.setItem('surat-masuk',JSON.stringify(suratMasuk));
                localStorage.setItem('surat-keluar',JSON.stringify(suratKeluar));
                console.log('‚úÖ Data tersimpan lokal');
            }catch(e){console.error('‚ùå Error:',e);throw e;}
        }

        function updateConnectionStatus(c){
            const s=document.getElementById('connectionStatus');
            s.className=c?'sync-status connected':'sync-status disconnected';
            s.innerHTML=c?'<span>‚óè</span> Terhubung ke Google Sheets':'<span>‚óè</span> Belum Terhubung';
        }

        function showAlert(m,t='info'){
            const c=document.getElementById('alertContainer');
            c.innerHTML=`<div class="alert alert-${t}">${m}</div>`;
            setTimeout(()=>c.innerHTML='',5000);
        }

        async function testConnection(){
            const b=document.getElementById('testBtnText');
            b.innerHTML='<div class="loading"></div> Testing...';
            try{
                const r=await fetch(apiUrl+'?action=test'),d=await r.json();
                if(d.status==='success'){
                    updateConnectionStatus(true);
                    showAlert('‚úÖ Koneksi berhasil!','success');
                }else throw new Error(d.message||'Koneksi gagal');
            }catch(e){
                console.error(e);
                updateConnectionStatus(false);
                showAlert('‚ùå Koneksi gagal: '+e.message,'danger');
            }finally{b.innerHTML='üîå Test Koneksi';}
        }

        async function syncFromSheet(){
            const b=document.getElementById('syncBtnText');
            b.innerHTML='<div class="loading"></div> Syncing...';
            try{
                const r=await fetch(apiUrl+'?action=getData'),d=await r.json();
                if(d.status==='success'){
                    suratMasuk=d.suratMasuk||[];
                    suratKeluar=d.suratKeluar||[];
                    saveLocalData();
                    filteredData=activeTab==='masuk'?[...suratMasuk]:[...suratKeluar];
                    currentPage=1;
                    renderTable();
                    showAlert('‚úÖ Data berhasil di-sync!','success');
                }else throw new Error(d.message||'Sync gagal');
            }catch(e){showAlert('‚ùå Sync gagal: '+e.message,'danger');}
            finally{b.innerHTML='üîÑ Sync Data';}
        }

        async function syncToSheet(a,s,r){
            try{
                const p={action:a,sheetType:s,data:r};
                const res=await fetch(apiUrl,{
                    method:'POST',
                    headers:{'Content-Type':'text/plain'},
                    body:JSON.stringify(p)
                });
                const t=await res.text(),d=JSON.parse(t);
                if(d.status!=='success')throw new Error(d.message||'Sync gagal');
                return d;
            }catch(e){console.error(e);throw e;}
        }

        function switchTab(t){
            activeTab=t;
            currentPage=1;
            document.querySelectorAll('.tab').forEach(e=>e.classList.remove('active'));
            event.target.closest('.tab').classList.add('active');
            document.getElementById('searchInput').value='';
            filteredData=activeTab==='masuk'?[...suratMasuk]:[...suratKeluar];
            renderTable();
        }

        function formatDisplayDate(d){
            if(!d||d==='-'||d==='')return'-';
            if(d.includes('/')&&d.length<=10)return d;
            
            // Handle various date formats
            try{
                let dt;
                
                // Check if it's already in DD/MM/YYYY format
                if(/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(d))return d;
                
                // Try to parse as ISO date or timestamp
                if(d.includes('T')||d.includes('-')||!isNaN(Date.parse(d))){
                    dt=new Date(d);
                }else{
                    // Try parsing DD-MM-YYYY or other formats
                    const parts=d.split(/[-\/]/);
                    if(parts.length===3){
                        // Assume DD-MM-YYYY or DD/MM/YYYY
                        dt=new Date(parts[2],parts[1]-1,parts[0]);
                    }else{
                        dt=new Date(d);
                    }
                }
                
                if(isNaN(dt.getTime()))return d;
                
                const day=String(dt.getDate()).padStart(2,'0');
                const month=String(dt.getMonth()+1).padStart(2,'0');
                const year=dt.getFullYear();
                
                return `${day}/${month}/${year}`;
            }catch(e){
                console.error('Date format error:',e,d);
                return d;
            }
        }

        function renderTable(){
            const d=filteredData,c=document.getElementById('tableContainer');
            if(d.length===0){
                c.innerHTML='<div class="empty-state"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg><h3>Belum ada data</h3><p>Klik "Tambah Surat" atau "Sync Data"</p></div>';
                return;
            }
            const total=Math.ceil(d.length/itemsPerPage),start=(currentPage-1)*itemsPerPage,end=Math.min(start+itemsPerPage,d.length),cur=d.slice(start,end);
            let h='<div class="table-container"><table><thead><tr>';
            if(activeTab==='masuk'){
                h+=`<th style="width:40px;">No</th>
                    <th style="width:100px;">Tanggal Surat</th>
                    <th style="width:100px;">Tanggal Masuk</th>
                    <th style="width:150px;">Nomor Surat</th>
                    <th style="width:150px;">Asal Surat</th>
                    <th style="width:250px;">Perihal</th>
                    <th style="width:150px;">Tujuan/Disposisi</th>
                    <th style="width:100px;">Tanggal Disposisi</th>
                    <th style="width:80px;">Status</th>
                    <th style="width:120px;">File Surat</th>
                    <th style="width:100px;">Aksi</th>`;
            }else{
                h+=`<th style="width:40px;">No</th>
                    <th style="width:100px;">Tanggal Surat</th>
                    <th style="width:150px;">Nomor Surat</th>
                    <th style="width:150px;">Tujuan</th>
                    <th style="width:250px;">Perihal</th>
                    <th style="width:150px;">Disposisi</th>
                    <th style="width:150px;">Ditandatangani</th>
                    <th style="width:80px;">Status</th>
                    <th style="width:120px;">File Surat</th>
                    <th style="width:100px;">Aksi</th>`;
            }
            h+='</tr></thead><tbody>';
            cur.forEach((i,x)=>{
                const n=start+x+1;
                h+=`<tr><td>${n}</td>`;
                if(activeTab==='masuk'){
                    h+=`<td style="white-space:nowrap;">${formatDisplayDate(i.tanggalSurat)}</td>
                        <td style="white-space:nowrap;">${formatDisplayDate(i.tanggalMasuk)}</td>
                        <td>${i.nomorSurat||'-'}</td>
                        <td>${i.asalSurat||'-'}</td>
                        <td style="white-space:normal;word-wrap:break-word;max-width:250px;">${i.perihal||'-'}</td>
                        <td>${i.tujuanDisposisi||'-'}</td>
                        <td style="white-space:nowrap;">${formatDisplayDate(i.tanggalDisposisi)}</td>
                        <td><span class="badge badge-${getStatusClass(i.status)}">${i.status||'-'}</span></td>
                        <td>${i.fileSurat?`<a href="${i.fileSurat}" target="_blank" class="file-link">üìÑ Lihat</a>`:'-'}</td>`;
                }else{
                    h+=`<td style="white-space:nowrap;">${formatDisplayDate(i.tanggalSurat)}</td>
                        <td>${i.nomorSurat||'-'}</td>
                        <td>${i.tujuan||'-'}</td>
                        <td style="white-space:normal;word-wrap:break-word;max-width:250px;">${i.perihal||'-'}</td>
                        <td style="white-space:normal;word-wrap:break-word;">${i.disposisiSurat||'-'}</td>
                        <td>${i.tandatangani||'-'}</td>
                        <td><span class="badge badge-${getStatusClass(i.status)}">${i.status||'-'}</span></td>
                        <td>${i.fileSurat?`<a href="${i.fileSurat}" target="_blank" class="file-link">üìÑ Lihat</a>`:'-'}</td>`;
                }
                h+=`<td><div class="actions">
                        <button class="btn btn-warning btn-sm" onclick="editSurat('${i.id}')">‚úèÔ∏è</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteSurat('${i.id}')">üóëÔ∏è</button>
                    </div></td></tr>`;
            });
            h+=`</tbody></table></div><div class="pagination"><button onclick="changePage(${currentPage-1})" ${currentPage===1?'disabled':''}>&laquo; Prev</button><span class="pagination-info">Menampilkan ${start+1}-${end} dari ${d.length} data</span><button onclick="changePage(${currentPage+1})" ${currentPage===total?'disabled':''}>Next &raquo;</button></div>`;
            c.innerHTML=h;
        }

        function changePage(p){
            const t=Math.ceil(filteredData.length/itemsPerPage);
            if(p<1||p>t)return;
            currentPage=p;
            renderTable();
        }

        function getStatusClass(s){
            if(!s)return'secondary';
            const l=s.toLowerCase();
            if(l.includes('selesai')||l.includes('terkirim'))return'success';
            if(l.includes('proses')||l.includes('draft'))return'warning';
            return'danger';
        }

        function openModal(m,id=null){
            const modal=document.getElementById('modal'),title=document.getElementById('modalTitle'),fields=document.getElementById('formFields');
            editingId=id;
            modal.classList.add('active');
            title.textContent=m==='add'?`Tambah Surat ${activeTab==='masuk'?'Masuk':'Keluar'}`:`Edit Surat ${activeTab==='masuk'?'Masuk':'Keluar'}`;
            let f='';
            if(activeTab==='masuk'){
                f=`<div class="form-group"><label>Tanggal Surat *</label><input type="date" id="tanggalSurat"></div>
                <div class="form-group"><label>Tanggal Masuk *</label><input type="date" id="tanggalMasuk"></div>
                <div class="form-group"><label>Nomor Surat *</label><input type="text" id="nomorSurat" placeholder="Contoh: 001/5/B67/2025"></div>
                <div class="form-group"><label>Asal Surat *</label><input type="text" id="asalSurat" placeholder="Contoh: Kabupaten"></div>
                <div class="form-group"><label>Perihal *</label><textarea id="perihal"></textarea></div>
                <div class="form-group"><label>Tujuan/Disposisi</label><input type="text" id="tujuanDisposisi"></div>
                <div class="form-group"><label>Tanggal Disposisi</label><input type="date" id="tanggalDisposisi"></div>
                <div class="form-group"><label>Status *</label><select id="status"><option value="">Pilih Status</option><option value="Selesai">Selesai</option><option value="Proses">Proses</option><option value="Pending">Pending</option></select></div>
                <div class="form-group"><label>File Surat PDF (URL)</label><input type="url" id="fileSurat" placeholder="https://drive.google.com/file/d/..."></div>`;
            }else{
                f=`<div class="form-group"><label>Tanggal Surat *</label><input type="date" id="tanggalSurat"></div>
                <div class="form-group"><label>Nomor Surat *</label><input type="text" id="nomorSurat"></div>
                <div class="form-group"><label>Tujuan *</label><input type="text" id="tujuan"></div>
                <div class="form-group"><label>Perihal *</label><textarea id="perihal"></textarea></div>
                <div class="form-group"><label>Disposisi Surat</label><textarea id="disposisiSurat"></textarea></div>
                <div class="form-group"><label>Ditandatangani Oleh</label><input type="text" id="tandatangani"></div>
                <div class="form-group"><label>Status *</label><select id="status"><option value="">Pilih Status</option><option value="Draft">Draft</option><option value="Terkirim">Terkirim</option><option value="Pending">Pending</option></select></div>
                <div class="form-group"><label>File Surat PDF (URL)</label><input type="url" id="fileSurat" placeholder="https://drive.google.com/file/d/..."></div>`;
            }
            fields.innerHTML=f;
            if(m==='edit'&&id){
                const data=activeTab==='masuk'?suratMasuk:suratKeluar,item=data.find(d=>d.id===id);
                if(item){
                    Object.keys(item).forEach(k=>{
                        const inp=document.getElementById(k);
                        if(inp&&k!=='id')inp.value=item[k]||'';
                    });
                }
            }
        }

        function closeModal(){
            document.getElementById('modal').classList.remove('active');
            document.getElementById('suratForm').reset();
            editingId=null;
        }

        async function saveSurat(){
            const btn=document.getElementById('saveBtnText');
            const form=document.getElementById('suratForm'),inputs=form.querySelectorAll('input,textarea,select');
            const formData={};
            inputs.forEach(i=>{if(i.id)formData[i.id]=i.value;});
            
            if(activeTab==='masuk'){
                if(!formData.tanggalSurat||!formData.tanggalMasuk||!formData.nomorSurat||!formData.asalSurat||!formData.perihal||!formData.status){
                    alert('Mohon lengkapi semua field yang wajib diisi (*)');
                    return;
                }
            }else{
                if(!formData.tanggalSurat||!formData.nomorSurat||!formData.tujuan||!formData.perihal||!formData.status){
                    alert('Mohon lengkapi semua field yang wajib diisi (*)');
                    return;
                }
            }
            
            btn.innerHTML='<div class="loading"></div> Menyimpan...';
            const data=activeTab==='masuk'?suratMasuk:suratKeluar;
            let action='';
            
            if(editingId!==null){
                const idx=data.findIndex(d=>d.id===editingId);
                if(idx!==-1){
                    data[idx]={...data[idx],...formData,id:editingId};
                    action='update';
                }else{
                    showAlert('Data tidak ditemukan','danger');
                    btn.innerHTML='üíæ Simpan';
                    return;
                }
            }else{
                formData.id='ID_'+Date.now().toString();
                data.push(formData);
                action='add';
            }
            
            if(activeTab==='masuk')suratMasuk=data;
            else suratKeluar=data;
            
            try{
                saveLocalData();
                filteredData=activeTab==='masuk'?[...suratMasuk]:[...suratKeluar];
            }catch(e){
                showAlert('‚ùå Gagal menyimpan data lokal','danger');
                btn.innerHTML='üíæ Simpan';
                return;
            }
            
            try{
                await syncToSheet(action,activeTab,formData);
                showAlert(`‚úÖ Data berhasil ${action==='add'?'ditambahkan':'diupdate'} dan disinkronkan`,'success');
            }catch(e){
                showAlert(`‚ö†Ô∏è Data tersimpan lokal, tapi gagal sync: ${e.message}`,'warning');
            }
            
            btn.innerHTML='üíæ Simpan';
            closeModal();
            currentPage=1;
            renderTable();
        }

        function editSurat(id){openModal('edit',id);}

        async function deleteSurat(id){
            if(!confirm('Apakah Anda yakin ingin menghapus data ini?'))return;
            let deleted;
            if(activeTab==='masuk'){
                deleted=suratMasuk.find(s=>s.id===id);
                if(!deleted){showAlert('Data tidak ditemukan','danger');return;}
                suratMasuk=suratMasuk.filter(s=>s.id!==id);
            }else{
                deleted=suratKeluar.find(s=>s.id===id);
                if(!deleted){showAlert('Data tidak ditemukan','danger');return;}
                suratKeluar=suratKeluar.filter(s=>s.id!==id);
            }
            try{
                saveLocalData();
                filteredData=activeTab==='masuk'?[...suratMasuk]:[...suratKeluar];
            }catch(e){
                showAlert('‚ùå Gagal menghapus data','danger');
                return;
            }
            try{
                await syncToSheet('delete',activeTab,deleted);
                showAlert('‚úÖ Data berhasil dihapus','success');
            }catch(e){
                showAlert('‚ö†Ô∏è Data terhapus lokal, tapi gagal sync: '+e.message,'warning');
            }
            renderTable();
        }

        function filterTable(){
            const s=document.getElementById('searchInput').value.toLowerCase();
            const data=activeTab==='masuk'?suratMasuk:suratKeluar;
            if(!s){
                filteredData=[...data];
                currentPage=1;
                renderTable();
                return;
            }
            filteredData=data.filter(i=>Object.values(i).some(v=>String(v).toLowerCase().includes(s)));
            currentPage=1;
            renderTable();
        }

        function logout(){
            if(confirm('Apakah Anda yakin ingin logout?')){
                localStorage.removeItem('isLoggedIn');
                localStorage.removeItem('username');
                window.location.href='https://upt-tpi.github.io/aplikasi-surat/login.html';
            }
        }

        function showDebugInfo(){
            const info=`=== DEBUG INFORMATION ===

API URL: ${apiUrl}
Active Tab: ${activeTab}
Surat Masuk Count: ${suratMasuk.length}
Surat Keluar Count: ${suratKeluar.length}

Surat Masuk (Local):
 ${JSON.stringify(suratMasuk,null,2)}

Surat Keluar (Local):
 ${JSON.stringify(suratKeluar,null,2)}

=== TROUBLESHOOTING ===
‚úì Data lokal tersimpan: ${suratMasuk.length+suratKeluar.length} data
‚úì LocalStorage working: ${localStorage.getItem('surat-masuk')?'YES':'NO'}
‚úì API configured: YES

Buka Console (F12) untuk melihat log detail`;
            alert(info);
            console.log(info);
        }
    </script>
</body>
</html>



